var Device=function(e){this.setValues(e)};Device.prototype.setValues=function(e){this.id=e.id,this.state=e.state},Device.prototype.setPending=function(e){},Device.prototype.showPendingMessge=function(e){msg="undefined"!=typeof this.battery?"Waiting for device to wake up to apply change":"Device change in progress",str='<div class="alert alert-success alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+msg+"</div>",$("#device-wrap"+this.id).append(str),setTimeout(function(){$(".alert").fadeOut("slow",function(){$(this).remove()})},2e3)};var Dimmer=function(e){Device.call(this,e)};Dimmer.prototype=Object.create(Device.prototype),Dimmer.prototype.constructor=Dimmer,Dimmer.prototype.render=function(e){onClass="on"==this.status?"success":"default",offClass="on"==this.status?"default":"danger",str='<div class="well device-wrap" data-device-type="dimmer" id="device-wrap'+this.id+'"><h3 class="device-title">'+this.label+'</h3><p><input id="device'+this.id+'" name="device'+this.id+'" data-slider-id="device'+this.id+'" type="text" data-slider-min="0" data-slider-max="100" data-slider-step="5" data-slider-value="'+this.level+'"/></p><p><button class="btn btn-'+onClass+'" data-relay="1" data-type="light" data-device-id="'+this.id+'">On</button><button class="btn btn-'+offClass+'" data-relay="0" data-type="light" data-device-id="'+this.id+'">Off</button></p></div>',e.append(str),this.sliderObject=$("#device"+this.id).slider();var t=this.id;this.sliderObject.on("slideStop",function(e){Robot.setDevice(t,"dimmer",e.value)})},Dimmer.prototype.setPending=function(e){$('[data-device-id="'+this.id+'"]').attr("disabled","disabled"),this.sliderObject.slider("disable"),$("#device-wrap"+this.id).addClass("pending")},Dimmer.prototype.setValues=function(e){this.id=e.device_id,this.label=e.name,this.level=e.state,this.status="off",e.state>0&&(this.status="on")};var Relay=function(e){Device.call(this,e)};Relay.prototype=Object.create(Device.prototype),Relay.prototype.constructor=Relay,Relay.prototype.render=function(e){onClass="on"==this.status?"success":"default",offClass="on"==this.status?"default":"danger",str='<div class="well device-wrap '+this.style_class+'" data-device-type="'+this.type+'" id="device-wrap'+this.id+'"><h3 class="device-title">'+this.label+'</h3><button class="btn btn-'+onClass+'" data-relay="1" data-type="'+this.type+'" data-device-id="'+this.id+'">On</button><button class="btn btn-'+offClass+'" data-relay="0" data-type="'+this.type+'" data-device-id="'+this.id+'">Off</button></p></div>',e.append(str)},Relay.prototype.setPending=function(e){$('[data-device-id="'+this.id+'"]').attr("disabled","disabled"),$("#device-wrap"+this.id).addClass("pending")},Relay.prototype.setValues=function(e){this.id=e.device_id,this.label=e.name,this.type=e.type,this.style_class=e.style_class,this.status="hvac"==this.type?"Off"==e.state?"off":"on":e.state>0?"on":"off"};var Battery=function(e){Device.call(this,e)};Battery.prototype=Object.create(Device.prototype),Battery.prototype.constructor=Battery,Battery.prototype.render=function(e){str="<p>"+this.desc+"</p>"+this.markup(),e.append(str)},Battery.prototype.markup=function(){return'<div class="progress"><div class="progress-bar progress-bar-striped progress-bar-'+this.bar_class+'" style="width: '+this.level+'%;">'+this.level+"%</div></div>"},Battery.prototype.setValues=function(e){this.desc=e[1],this.level=e[0],this.bar_class=this.level<=10?"danger":this.level<=20?"warning":this.level<=50?"default":"success"};var Thermostat=function(e){Device.call(this,e)};Thermostat.prototype=Object.create(Device.prototype),Thermostat.prototype.constructor=Thermostat,Thermostat.prototype.render=function(e){bat=new Battery([this.battery,this.label]),str='<div class="well device-wrap" data-type="stat" id="device-wrap'+this.id+'"><h3 class="device-title">'+this.label+'</h3><div class="row"><div class="col-xs-8"><input id="device'+this.id+'" name="device'+this.id+'" data-slider-id="device'+this.id+'" type="text" data-slider-min="5" data-slider-max="25" data-slider-step="1"  data-slider-value="'+this.level+'"/></div>'+this.currentTemp()+'</div><div class="row"><div class="col-xs-8"><input type="number" class="form-control" min="5" max="25" data-stat="'+this.id+'" value="'+this.level+'"></div><div class="col-xs-4"><p>Battery</p>'+bat.markup()+"</div></div></div>","rad"==this.type?e.append(str):e.prepend(str),this.sliderObject=$("#device"+this.id).slider();var t=this.id;this.sliderObject.on("slideStop",function(e){Robot.setDevice(t,"stat",e.value)})},Thermostat.prototype.setPending=function(e){$('[data-stat="'+this.id+'"]').attr("disabled","disabled"),this.sliderObject.slider("disable"),$("#device-wrap"+this.id).addClass("pending")},Thermostat.prototype.setValues=function(e){this.id=e.device_id,this.label=e.name,this.level=e.state,this.current=e.current,this.type=e.type,this.battery=e.battery_level},Thermostat.prototype.currentTemp=function(e){return"rad"==this.type?"":'<div class="col-xs-4"><p class="temperature text-center">'+this.current+"&deg;</p></div>"};var Temperature=function(e){Device.call(this,e)};Temperature.prototype=Object.create(Device.prototype),Temperature.prototype.constructor=Temperature,Temperature.prototype.render=function(e){bat=new Battery([this.battery,this.label]),str='<div class="well device-wrap" data-type="stat" id="device-wrap'+this.id+'"><h3 class="device-title">'+this.label+'</h3><div class="row">'+this.currentTemp()+'<div class="col-xs-4"><p>Battery</p>'+bat.markup()+"</div></div></div>","rad"==this.type?e.append(str):e.prepend(str)},Temperature.prototype.setValues=function(e){this.id=e.device_id,this.label=e.name,this.level=e.state,this.current=e.current,this.type=e.type,this.battery=e.battery_level},Temperature.prototype.currentTemp=function(e){return'<div class="col-xs-6 col-xs-offset-2"><p class="temperature">'+this.current+"&deg;</p></div>"};var Shortcut=function(e){Device.call(this,e)};Shortcut.prototype=Object.create(Device.prototype),Shortcut.prototype.constructor=Shortcut,Shortcut.prototype.render=function(e){classState="btn-default",readyIcon="",playIcon="",href="#",dataLink="","room"==this.type?href="/#/room/"+this.slug:(dataLink='data-scene="'+this.scene+'"',this.active?(readyIcon='<span class="glyphicon glyphicon-ok"></span> ',classState="btn-success"):playIcon=' <span class="glyphicon glyphicon-play">'),str='<a class="btn btn-shortcut '+classState+'" id="shortcut'+this.id+'"href="'+href+'" '+dataLink+">"+readyIcon+this.desc+playIcon+"</span></a>",e.append(str)},Shortcut.prototype.setValues=function(e){this.id=e.id,this.type=e.type,"room"==this.type?(this.desc=e.room_name,this.slug=e.room_slug,this.active=null):(this.scene=e.scene_number,this.desc=e.scene_name,this.active=e.active)};var Robot=function(){};Robot.devices={},Robot.shorcutsRendered={},Robot.reloading=null,Robot.route=function(){location.hash?Robot.room():Robot.dash(),window.scrollTo(0,0)},Robot.room=function(){function e(){$("#lights, #climate").hide(),s.html(""),i.html("")}function t(e){$("#room-name").text(e.name);for(var t in e.devices)switch(devName="device"+e.devices[t].device_id,e.devices[t].type){case"dimmer":Robot.devices[devName]=new Dimmer(e.devices[t]),Robot.devices[devName].render(s),a=!0;break;case"light":Robot.devices[devName]=new Relay(e.devices[t]),Robot.devices[devName].render(s),a=!0;break;case"rad":case"stat":Robot.devices[devName]=new Thermostat(e.devices[t]),Robot.devices[devName].render(i),o=!0;break;case"temp":Robot.devices[devName]=new Temperature(e.devices[t]),Robot.devices[devName].render(i),o=!0;break;case"hvac":Robot.devices[devName]=new Relay(e.devices[t]),Robot.devices[devName].render(i),o=!0}a&&$("#lights").show(),o&&$("#climate").show()}$("#dash").addClass("hidden"),$("#room").removeClass("hidden");var s=$("#lights-devices"),i=$("#climate-devices"),a=!1,o=!1;return e(),name=location.hash.replace("#/room/",""),room=Robot.rooms[name],"undefined"==typeof room?void(location.hash=""):void t(room)},Robot.showMessage=function(e){alert(e)},Robot.dash=function(){function e(e,t){sName="shortcut"+e.id,Robot.shorcutsRendered[sName]=new Shortcut(e),Robot.shorcutsRendered[sName].render(t)}function t(){r.html(""),d.html(""),n.html(""),c.html("")}function s(){$.each(Robot.shortcuts.shortcut,function(t,s){e(s,r)}),$.each(Robot.shortcuts.room,function(t,s){e(s,d)}),$.each(Robot.shortcuts.heating,function(t,s){e(s,n)})}function a(){str='<hr><div class="row">',$.each(Robot.rooms.services.devices,function(e,t){cls="Off"==t.state?"info":"danger",lbl="Off"==t.state?"Off":"On",str+='<div class="col-xs-6"><p>'+t.name+': <span class="label label-'+cls+'">'+lbl+"</label></p></div>"}),str+="</div>",n.append(str)}function o(){var e=[];if($.each(Robot.rooms,function(t,s){var i=s.name;for(var a in s.devices)s.devices[a].is_battery===!0&&s.devices[a].battery_level<=20&&(s.devices[a].room_name=i,e.push([s.devices[a].battery_level,i+": "+s.devices[a].name]))}),!e.length)return!1;for(e.sort(function(e,t){return e[0]-t[0]}),i=0;i<e.length;i++)b=new Battery(e[i]),b.render(c);return!0}$("#room").addClass("hidden"),$("#dash").removeClass("hidden");var r=$("#dash-shortcuts"),d=$("#dash-rooms"),n=$("#dash-heating"),c=$("#battery-wrap");t(),s(),o()&&$("#battery-panel").removeClass("hidden"),a()},Robot.refreshData=function(e){Robot.rooms=e.rooms,Robot.shortcuts=e.shortcuts},Robot.runScene=function(e){function t(e){e.hasClass("btn-success")||e.addClass("scene-pending")}Robot.shorcutsRendered[e.attr("id")];t(e),$.ajax({type:"POST",url:"/run-scene",data:"scene="+e.data("scene")}).done(function(e){Robot.refreshData(e)}).fail(function(e){Robot.showMessage("Scene could not be run"),$(".scene-pending").removeClass("scene-pending")}).always(function(){Robot.route()})},Robot.setDevice=function(e,t,s){var i="device"+room.devices[e].device_id;Robot.devices[i].setPending(),$.ajax({type:"POST",url:"/set-device",data:{id:e,type:t,value:s}}).done(function(e,t,s){setTimeout(Robot.reload,1e3)}).fail(function(){Robot.showMessage("Device could not be set")}).always(function(){Robot.route(),Robot.devices[i].showPendingMessge()})},Robot.reload=function(){return Robot.reloading&&Robot.reloading.abort(),Robot.reloading=$.ajax({type:"GET",url:"/refresh"}).done(function(e){Robot.reloading=null,Robot.refreshData(e),Robot.route()}),Robot.reloading},Robot.refresh=function(){$(".data-refresh").addClass("pending").attr("disabled","disabled"),Robot.reload().always(function(){$(".data-refresh").removeClass("pending").removeAttr("disabled")})},window.onhashchange=Robot.route,document.getElementById("back").addEventListener("click",function(){location.hash=""}),document.getElementById("refresh").addEventListener("click",Robot.refresh),$(document).on("click","[data-scene]",function(e){e.preventDefault(),Robot.runScene($(this))}),$(document).on("click","[data-relay]",function(){Robot.setDevice($(this).data("device-id"),$(this).data("type"),$(this).data("relay"))}),$(document).on("change","[data-stat]",function(){Robot.setDevice($(this).data("stat"),"stat",$(this).val())}),function(){{var e=function(){t+=1,t>10&&(Robot.reload(),t=0)},t=0;setInterval(e,1e3)}document.addEventListener("mousemove",function(){t=0}),document.addEventListener("keypress",function(){t=0}),document.addEventListener("touchend",function(){t=0})}();